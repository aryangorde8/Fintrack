{% extends 'base.html' %}
{% block content %}
<h2>Transactions</h2>

<!-- Budget Alert Popup -->
<div class="popup-overlay" id="budgetAlertPopup">
  <div class="popup-modal">
    <div class="icon">⚠️</div>
    <h2>Budget Limit Exceeded!</h2>
    <p id="budgetAlertMessage"></p>
    <button class="btn danger" onclick="closePopup()">Got It</button>
  </div>
</div>

{% if messages %}
  {% for message in messages %}
    <div class="alert {% if 'error' in message.tags %}alert-danger{% elif 'warning' in message.tags %}alert-warning{% else %}alert-success{% endif %} fade-up">{{ message }}</div>
  {% endfor %}
{% endif %}

<form method="POST" class="section card fade-up">
    {% csrf_token %}
    <label>Type</label>
    <select name="type" required>
        <option value="expense">Expense</option>
        <option value="income">Income</option>
    </select>
    
    <label>Amount (₹)</label>
    <input type="number" step="0.01" name="amount" required>
    
    <label>Category</label>
    <input type="text" name="category" required>
    
    <label>Description</label>
    <textarea name="description" rows="3"></textarea>
    
    <div class="spacer-1"></div>
    <button class="btn" type="submit">Add Transaction</button>
  </form>

<h3>Recent Transactions</h3>
<div class="card section fade-up">
  <table>
      <tr>
          <th>Date</th>
          <th>Type</th>
          <th>Category</th>
          <th>Amount</th>
          <th>Description</th>
      </tr>
      {% for tx in transactions %}
      <tr>
          <td>{{ tx.date|date:"Y-m-d H:i" }}</td>
          <td>{{ tx.type|upper }}</td>
          <td>{{ tx.category }}</td>
            <td>₹{{ tx.amount|floatformat:2 }}</td>
          <td>{{ tx.description }}</td>
      </tr>
      {% endfor %}
  </table>
  </div>

<script>
  // Check for budget warning messages and show popup
  document.addEventListener('DOMContentLoaded', function() {
    const alerts = document.querySelectorAll('.alert-warning');
    alerts.forEach(alert => {
      const message = alert.textContent.trim();
      if (message.includes('budget used') || message.includes('Budget alert')) {
        showBudgetPopup(message);
      }
    });
  });

  function showBudgetPopup(message) {
    document.getElementById('budgetAlertMessage').textContent = message;
    document.getElementById('budgetAlertPopup').classList.add('show');
  }

  function closePopup() {
    document.getElementById('budgetAlertPopup').classList.remove('show');
  }

  // Close popup when clicking outside
  document.getElementById('budgetAlertPopup').addEventListener('click', function(e) {
    if (e.target === this) {
      closePopup();
    }
  });
</script>
{% endblock %}
