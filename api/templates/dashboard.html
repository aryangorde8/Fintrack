{% extends 'base.html' %}
{% block content %}
<div class="fade-in">
  <h1>Dashboard</h1>
  <p class="muted">Welcome back, {{ user.username }}! Here's your financial overview.</p>
</div>

{% if not has_data %}
<div class="card empty-state fade-up section">
  <h3>ğŸš€ Get Started</h3>
  <p class="muted">Create budgets and add transactions to see your financial insights come to life.</p>
  <div class="cta-row">
    <a class="btn" href="{% url 'api:web-budgets' %}">Create Budget</a>
    <a class="btn success" href="{% url 'api:web-transactions' %}">Add Transaction</a>
  </div>
</div>
{% endif %}

<div class="grid-3 section stagger">
  <div class="card kpi income">
    <h3>ğŸ’° Total Income</h3>
    <div class="value">â‚¹{{ income_total|floatformat:2 }}</div>
  </div>
  <div class="card kpi expense">
    <h3>ğŸ’¸ Total Expenses</h3>
    <div class="value">â‚¹{{ expense_total|floatformat:2 }}</div>
  </div>
  <div class="card kpi">
    <h3>ğŸ“Š Net Balance</h3>
    <div class="value" style="color: {% if net_amount >= 0 %}var(--success){% else %}var(--danger){% endif %}">â‚¹{{ net_amount|floatformat:2 }}</div>
  </div>
</div>

{% if budget_warnings %}
<div class="section fade-up">
  <h3 class="section-title">âš ï¸ Budget Alerts</h3>
  <div class="card">
    <ul class="warn-list">
      {% for warning in budget_warnings %}
      <li>{{ warning }}</li>
      {% endfor %}
    </ul>
  </div>
</div>
{% endif %}

<div class="grid-2 section stagger">
  <div class="card chart-card">
    <h3 class="section-title">ğŸ“ˆ Spending Trend (30 Days)</h3>
    {% if has_trend_data %}
      <canvas id="trendChart"></canvas>
    {% else %}
      <p class="empty-state">Add expenses to visualize your spending patterns</p>
    {% endif %}
  </div>
  <div class="card chart-card">
    <h3 class="section-title">ğŸ¯ Top Categories</h3>
    {% if has_breakdown_data %}
      <canvas id="breakdownChart"></canvas>
    {% else %}
      <p class="empty-state">Category breakdown appears after logging expenses</p>
    {% endif %}
  </div>
</div>

<div class="grid-2 section stagger">
  <div class="card">
    <h3 class="section-title">ğŸ“ Budget Overview</h3>
    {% if budgets_summary %}
      <ul class="insight-list">
        {% for budget in budgets_summary|slice:':5' %}
        <li>
          <span>{{ budget.category }}</span>
          <div style="display: flex; align-items: center; gap: 12px;">
            <span class="badge {% if budget.utilization_pct >= 100 %}danger{% elif budget.utilization_pct >= budget.alert_threshold %}warn{% else %}ok{% endif %}">
              {{ budget.utilization_pct }}%
            </span>
            <strong>â‚¹{{ budget.spent_amount|floatformat:0 }}/â‚¹{{ budget.limit_amount|floatformat:0 }}</strong>
          </div>
        </li>
        {% endfor %}
      </ul>
      {% if budgets_summary|length > 5 %}
        <div style="margin-top: 16px;">
          <a class="inline" href="{% url 'api:web-budgets' %}">View all budgets â†’</a>
        </div>
      {% endif %}
    {% else %}
      <p class="empty-state">No budgets yet</p>
    {% endif %}
  </div>
  <div class="card">
    <h3 class="section-title">ğŸ§¾ Recent Activity</h3>
    {% if recent_transactions %}
      <ul class="insight-list">
        {% for tx in recent_transactions %}
        <li>
          <span>{{ tx.date|date:"M d, H:i" }} Â· {{ tx.category }}</span>
          <strong style="color: {% if tx.type == 'expense' %}var(--danger){% else %}var(--success){% endif %}">
            {% if tx.type == 'expense' %}-{% else %}+{% endif %}â‚¹{{ tx.amount|floatformat:2 }}
          </strong>
        </li>
        {% endfor %}
      </ul>
      <div style="margin-top: 16px;">
        <a class="inline" href="{% url 'api:web-transactions' %}">View all transactions â†’</a>
      </div>
    {% else %}
      <p class="empty-state">No transactions yet</p>
    {% endif %}
  </div>
</div>

{% if has_trend_data or has_breakdown_data %}
<script>
(function() {
  if (typeof Chart === 'undefined') { return; }
  Chart.defaults.color = '#a0a0a0';
  Chart.defaults.borderColor = 'rgba(0, 255, 157, 0.1)';
  
  {% if has_trend_data %}
  const trendCtx = document.getElementById('trendChart');
  if (trendCtx) {
    // Create gradient
    const ctx = trendCtx.getContext('2d');
    const gradient = ctx.createLinearGradient(0, 0, 0, 300);
    gradient.addColorStop(0, 'rgba(0, 255, 157, 0.4)');
    gradient.addColorStop(0.5, 'rgba(0, 255, 157, 0.15)');
    gradient.addColorStop(1, 'rgba(0, 255, 157, 0)');
    
    new Chart(trendCtx, {
      type: 'line',
      data: {
        labels: {{ trend_labels_json|safe }},
        datasets: [{
          label: 'Daily Spending',
          data: {{ trend_values_json|safe }},
          tension: 0.4,
          borderWidth: 3,
          borderColor: '#00ff9d',
          backgroundColor: gradient,
          pointRadius: 5,
          pointHoverRadius: 10,
          pointBackgroundColor: '#00ff9d',
          pointBorderColor: '#000',
          pointBorderWidth: 2,
          pointHoverBackgroundColor: '#fff',
          pointHoverBorderColor: '#00ff9d',
          pointHoverBorderWidth: 3,
          fill: true,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: 'index',
          intersect: false,
        },
        plugins: { 
          legend: { display: false },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.95)',
            padding: 16,
            borderColor: '#00ff9d',
            borderWidth: 2,
            titleColor: '#00ff9d',
            bodyColor: '#fff',
            titleFont: { size: 14, weight: 'bold' },
            bodyFont: { size: 14 },
            displayColors: false,
            callbacks: {
              title: function(context) {
                return 'ğŸ“… ' + context[0].label;
              },
              label: function(context) {
                return 'ğŸ’¸ Spent: â‚¹' + context.parsed.y.toLocaleString();
              }
            }
          }
        },
        scales: {
          x: { 
            grid: { display: false },
            ticks: { 
              color: '#a0a0a0',
              font: { size: 12, weight: '500' }
            }
          },
          y: { 
            beginAtZero: true,
            grid: { 
              color: 'rgba(0, 255, 157, 0.1)',
              lineWidth: 1
            },
            ticks: { 
              color: '#a0a0a0',
              font: { size: 12 },
              callback: function(value) {
                return 'â‚¹' + value.toLocaleString();
              }
            }
          }
        }
      }
    });
  }
  {% endif %}
  {% if has_breakdown_data %}
  const breakdownCtx = document.getElementById('breakdownChart');
  if (breakdownCtx) {
    const colors = [
      '#00d4ff',  // Cyan
      '#00ff9d',  // Neon Green
      '#ffd700',  // Gold
      '#ff0066',  // Pink
      '#9d4edd',  // Purple
      '#ff6b35'   // Orange
    ];
    
    new Chart(breakdownCtx, {
      type: 'doughnut',
      data: {
        labels: {{ breakdown_labels_json|safe }},
        datasets: [{
          data: {{ breakdown_values_json|safe }},
          backgroundColor: colors,
          borderColor: '#000',
          borderWidth: 4,
          hoverBorderColor: '#fff',
          hoverBorderWidth: 4,
          hoverOffset: 15,
          spacing: 2,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        layout: {
          padding: 10
        },
        plugins: { 
          legend: { 
            position: 'bottom',
            labels: { 
              color: '#fff',
              padding: 20,
              font: { size: 13, weight: '600' },
              usePointStyle: true,
              pointStyle: 'rectRounded',
              boxWidth: 15,
              boxHeight: 15
            } 
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.95)',
            padding: 18,
            borderColor: '#00ff9d',
            borderWidth: 2,
            titleColor: '#00ff9d',
            bodyColor: '#fff',
            titleFont: { size: 15, weight: 'bold' },
            bodyFont: { size: 14 },
            displayColors: true,
            boxWidth: 12,
            boxHeight: 12,
            boxPadding: 6,
            callbacks: {
              title: function(context) {
                return 'ğŸ·ï¸ ' + context[0].label;
              },
              label: function(context) {
                const value = 'â‚¹' + context.parsed.toLocaleString();
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = ((context.parsed / total) * 100).toFixed(1) + '%';
                return '  ğŸ’° ' + value + ' (' + percentage + ')';
              }
            }
          }
        },
        cutout: '65%',
        radius: '90%'
      }
    });
  }
  {% endif %}
})();
</script>
{% endif %}
{% endblock %}
